# Stanford CS107

## Memory Segments

Soft managed memory:

When a program are loaded to memory,
the heap part is managed by `malloc`, `relloc`, `free`.

The memory space allocated for you will contains more bytes just before the head.
The meta data information.

Thus, `free(head+offset);` is not allowed.
For `malloc` needs meta data, index with offset will lead to crash.

Furthermore, free a array is not allowed, as well.
For array are space allocated in stack and managed by compiler.
Which also contains no meta data.

Memory manager may spilt memory into segments,
and just allocate memory space for you
within some specify segment if request less than 2^n bytes.

## Memory compose

Split a large space of memory to handle memory allocation using handler.
Handler are some pointer points to the pointer points to actual memory.

## Stack segment

Stack depth roughly relative with function call count.

When define a variable or array within a function, like main,
it will create stack frame, increase stack top.
(Stack increase towards low address).
(Similarly, heap increase towards higher address).

Stack top pointer is embedded within stack and split the stack and gap.
(Gap is the space between heap and stack)

When a function has been called, a stack frame will create for it,
when a function exited, stack top pointer will go back to where before frame.

```text
Relatively slow RAM (Compared to register):

High address        +-----------------------+       +-------------+
                    |                       |      /|    ARG-N    |
                    |                       |     / |    .....    |
                    |                       |    /  |    ARG-1    |
                    |                       |   /   |-------------|
                    |-----------------------|  /    |  <Ret Addr> | <- BP
                    |                       | /    .|-------------|
                    |         Stack         |/    / |   <Old SP>  |
                    |                       |    /  |-------------|
              BP -> |-----------------------| --`   |   Local-1   |
                    |         Frame         |       |   .......   |
              SP -> |-----------------------| ----. |   Local-N   |
                    |                       |\     `|-------------|
                    |                       | \     |    ARGs-N   | <- SP
                    |                       |  \    |             |
                    |                       |   \   |             |
                    |                       |    \  |             |
                    |                       |     \ +-------------+
                    |                       | <- "Gap"
                    |                       |
                    |                       |
                    |                       |
                    |                       |
                    |                       |
                    |-----------------------|
                    |                       |
                    |                       |
                    |         Heap          |
                    |                       |
                    |                       |
                    |                       |
                    |-----------------------|
                    |                       |
                    |     .Section code     |
                    |                       |
Low address         +-----------------------+
```

## Memory Management

When memory allocating, memory allocator will not only allocate memory you request,
but also some extra memory for meta data.

``` text
|   total space allocated    |
| head | space you allocated |
       ^
       pointer points to
```

Some times memory manager may use some free space for storing
free space block meta data.

Allocate strategy:

- Best fit
- Worst fit
- First fit
- Continuous search

Some times memory allocator may return more space you need, but you can only
rely on space you request.

Compact:
